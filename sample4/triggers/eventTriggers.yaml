settings:
  dryrun: false
eventTriggers:
  - eventSource: github
    input: message
    body:
#     Initialize
      - build: 'call("preprocessGithubWebhook", message)'
      - kabanero : 'kabaneroConfig()'
 ###################################################################
 #    CUSTOMIZE THESE
 ###################################################################33
 #    *** General Build Related ***
      - build.namespace : ' kabanero.namespace ' 
      - build.timeout : ' "1h0m0s" '
      - build.jobid : ' jobID() '
      - build.nameSuffix: |- # suffix for Kubernetes resource names
          toDomainName(
              build.ownerLogin + "-" + build.repositoryName + "-" 
              + has(build.pr.url)?  "pr" : ( has(build.tag.sha) ? "tag": build.repositoryEvent)
              + "-" + build.jobid)
      - build.defaultRegistry : ' "image-registry.openshift-image-registry.svc:5000" '
      - build.serviceAccount : ' "kabanero-operator" '
#     *** Push ****
      - if: ' has(build.push.sha)'
        body:
          - build.push.allowedBranches : ' [ "master" ] '
          - build.push.toRegistry: ' build.defaultRegistry + "/" + build.namespace +  "/" +  build.repositoryName + ":" + build.push.sha'
#     *** Pull Request ***
      - if: 'has(build.pr.url)'
        body:
          - build.pr.allowedBranches:  ' [ "master" ] '
#    *** Tag ***
      - if: 'has(build.tag.version)'
        body:
          - build.tag.pattern : '"\\d\\.\\d\\.\\d"' # only tags that follow this pattern are processed.
          - build.tag.promoteToNamespace : ' build.repositoryName + "-test" '
          - build.tag.fromRegistry : ' build.defaultRegistry+ "/" + build.namespace +  "/" +  build.repositoryName + ":" + build.tag.sha '
          - build.tag.toRegistry : 'build.defaultRegistry+ "/" + build.tag.promoteToNamespace + "/" +  build.repositoryName + ":" + build.tag.version '
 ###################################################################
 #    END CUSTOMIZATION 
 ###################################################################33
      - if : 'has(build.collectionID) '
        body:
          #****************** Appsody Build ************************
          switch:
            - if: 'has(build.push.branch) && build.push.branch in build.push.allowedBranches'
              temp.pushResult : 'call("applyResources", "push", build)'
            - if : 'has(build.pr.branch) && build.pr.branch in build.pr.allowedBranches  && (build.pr.action == "opened" || build.pr.action == "synchronize") '
              temp.prResult : 'call("applyResources", "pull", build)'
            - if: 'has(build.tag.sha) '
              temp.tagResult : 'call("applyResources", "tag", build)'
